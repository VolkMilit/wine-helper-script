#!/bin/bash
conf=$HOME/.config/wine_helper/settings.conf

VER="1.7.0"

RUNTIME="$HOME/.steam/runtime/run.sh"
dir="/opt"
default_prefix=".wine64"
wine_prefixes_dir="$HOME/.local/share/wine_prefix/"

if [ -f $conf ]; then
	RUNTIME=`awk -F "=" '/runtime_command/ {print $2}' $conf`
	dir=`awk -F "=" '/wine_dir/ {print $2}' $conf`
	default_prefix=`awk -F "=" '/default_prefix/ {print $2}' $conf`
	wine_prefixes_dir=`awk -F "=" '/wine_prefixes_dir/ {print $2}' $conf`
fi

wine_ver_get=`ls $dir | sort --version-sort | sed '/wine/!d; $!d'` # get the lasted version of wine in dir, e.g. wine_1.8.0
wine_path=$dir$wine_ver_get"/bin/"

function help() 
{
	echo "Usage: wine PROGRAM [ARGUMENTS...]
       wine -h			     		Display wine script help
       wine -v					Display wine script version
       wine --version				Display (lastes you have) wine version
       wine --help                   		Display wine help and exit
       wine --version               		Output version information and exit
       wine --patches               		Output patch information and exit
       wine --check-libs            		Checks if shared libs are installed
       wine -np|--new-prefix	     		Create new prefix
       wine -p|--prefix				Set wine prefix (if you have problems with this, use WINEPREFIX=* instead)
       wine -a|--arch				Set wine arch (if you have problems with this, use ARCH=* instead)
       wine -wvs|--wine-version-set		Set wine version to use
       wine --check-wine-version		Check if wine-starging need to be updated
       wine --set-shortcut			Set shortcut
       wine -k|--kill 				Try to kill wineserver
       wine -wc|--use-write-copy-varible 	See https://github.com/wine-compholio/wine-staging/wiki/Environment-Variables
       wine -sm|--use-shared-memory-varible 	See https://github.com/wine-compholio/wine-staging/wiki/Environment-Variables
       
       WINEPREFIX=/prefix/path			Use specific prefix
       WINEARCH=win32				Use wine 32bit prefix
       ARCH=win32				Use 32bit wine binaries
       WINEDLLOVERRIDES=[dlls]			Override dlls, e.g.:
						'd3dx9=n,b;C:\user\d3dx9=b;...',
						n -- native, b -- blutin
       WINEDEBUG=[channels]			Use debug, e.g.: +all,-relay; warn+heap

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY (c) 2015-`date +'%Y'` Volk_Milit"
}

function deleteWineAssociations()
{
	rm $HOME/.local/share/applications/wine-extension*
	sed -i '/FileOpenAssociations/d;/AppName/d;/DesktopFile/d;/Associations/d;/MimeType/d;/OpenWithIcon/d;/ProgID/d' $WINEPREFIX/user.reg
}

if [ "$1" = "-v" ]; then
	echo "WINE helper version is $VER"
	exit 0
elif [ "$1" = "-h" ]; then
	help
	exit 0
elif [ "$1" = "--check-wine-version" ]; then
	wine-update
	exit 0
elif [ "$1" = "--set-shortcut" ]; then
	wine-shortcut $@
	exit 0
elif [ "$1" = "--delete-junk-associations" ]; then
	deleteWineAssociations
	exit 0
fi

for i in "$@"; do
	case $i in
		-wvs=*|--wine-ver-set=*)
		wine_path=$dir"wine_${i#*=}/bin/"
		shift
		;;
		
		-np|--new-prefix)
		WINEPREFIX=$WINEPREFIX $wine_path$ww wineboot
		shift
		;;
		
		-p=*|--prefix=*)
		WINEPREFIX=$wine_prefixes_dir"${i#*=}"
		shift
		;;
		
		-a=*|--arch=*)
		ARCH="${i#*=}"
		shift
		;;
		
		-k|--kill)
		WINEPREFIX=$WINEPREFIX ${wine_path}wineserver -k
		shift
		;;
		
		-wc|--use-write-copy-varible)
		wc=1
		shift
		;;
		
		-sm|--use-shared-memory-varible)
		sm=1
		shift
		;;
		
		*)
		#help
		#exit 0
		;;
	esac
done

if [ -z "$WINEPREFIX" ]; then WINEPREFIX=$wine_prefixes_dir$default_prefix; fi
if [ -z $wc ]; then wc=0; fi
if [ -z $sm ]; then sm=0; fi

prefix=`awk -F "=" '/#arch/ {print $2}' $WINEPREFIX/user.reg`

if [[ ! -z "$ARCH" || "$prefix" = "win32" ]]; then
	ww="wine"
	echo "msg: Use 32bit wine"
else
	ww="wine64"
	echo "msg: Use 64bit wine (by default)"
fi

if [ -z $RUNTIME ]; then
	echo "msg: Use NO runtime."
else
	echo "msg: Use \"$RUNTIME\" command to provide runtime."
fi

wine_ver=`echo $wine_path | sed 's/[\/_optwineb]//g'`

echo "msg: running wine verion $wine_ver" 
STAGING_WRITECOPY=$wc STAGING_SHARED_MEMORY=$sm WINEPREFIX=$WINEPREFIX $RUNTIME $wine_path$ww $1
